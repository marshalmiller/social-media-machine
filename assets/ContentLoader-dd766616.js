import{$ as B,c as T,j as d,r as y,m as M}from"./index-02b2945e.js";import{J as $,d as x,V as I,a as P}from"./settings-1d1f0ea7.js";import{l as b}from"./lz-string-35001fa0.js";import{l as D}from"./localiser-c0c9a31b.js";import{D as O,a as J}from"./DialogContent-d100c3e0.js";import{D as C}from"./DialogTitle-3bd65ba4.js";import{L as q}from"./LinearProgress-51654afb.js";function U(s){return s.reduce((t,r)=>Math.max(t,r.timestamp),0)}function z(s){return s.reduce((t,r)=>Math.max(t,r.log.reduce((c,l)=>Math.max(c,l.timestamp),0)),0)}function G(s,t){s.forEach(r=>{r.log.forEach(c=>{c.timestamp+=t})})}const S="genai_somekone_graph",_="genai_somekone_logs";let L=!1;const R={save:!0};function pe(){R.save=!1}function N(s,t){const r=window.sessionStorage.getItem(S);window.sessionStorage.removeItem(S);const c=window.sessionStorage.getItem(_);if(window.sessionStorage.removeItem(_),r){const l=JSON.parse(b.decompress(r));s.addNodes(l)}c&&JSON.parse(b.decompress(c)).forEach(e=>{t.appendActionLog(e.log,e.id)}),L||(window.addEventListener("beforeunload",()=>{if(R.save)try{window.sessionStorage.setItem(S,b.compress(JSON.stringify(s.dumpNodes())));const e=s.getNodesByType("user").map(a=>({id:a,log:t.getActionLog(a)}));window.sessionStorage.setItem(_,b.compress(JSON.stringify(e)))}catch(l){console.log("Save error",l)}}),L=!0)}const H=["cute","scary","dark","funny","happy","sad","artistic","beautiful","angry","complex","simple","indoor","outdoor","day","night","active","calm","adventure","romantic","colourful","inspiring","söpö","pelottava","synkkä","hauska","onnellinen","surullinen","taiteellinen","kaunis","vihainen","romanttinen","rauhallinen","kiehtova","elävä","kotoisa","salaperäinen","sopusointuinen","ihastuttava","hurmaava","unenomainen"],F=new Set(H);function K(s){return F.has(s)}const k="https://store.gen-ai.fi/somekone/images";async function V(s,t){if(typeof s=="string"){t&&t(0);const r=await fetch(s);if(r.status!==200)throw console.error(r),new Error("zip_fetch_failed");const c=[];if(r.body){const l=r.body.getReader(),e=parseInt(r.headers.get("Content-Length")||"1");let a=0;for(;a<e;){const{done:u,value:p}=await l.read();if(u)break;c.push(p),a+=p.length,t&&t(Math.floor(a/e*100))}}return new Blob(c)}else return t&&t(100),new Blob([s])}function W(s){return s.forEach(t=>{t.log.forEach(r=>{switch(r.activity){case"love":case"wow":case"laugh":case"anger":case"sad":r.activity="like";break;case"share_friends":case"share_private":r.activity="share_public";break}})}),s}async function Y(s,t,r){const c=await $.loadAsync(r),l=new Map,e={meta:[],users:[],logs:[]},a=[];if(c.forEach((i,o)=>{if(o.name==="content.json")a.push(o.async("string").then(n=>{e.meta=JSON.parse(n)}));else if(o.name==="users.json")a.push(o.async("string").then(n=>{e.users=JSON.parse(n)}));else if(o.name==="logs.json")a.push(o.async("string").then(n=>{e.logs=W(JSON.parse(n))}));else if(o.name==="graph.json")a.push(o.async("string").then(n=>{e.graph=JSON.parse(n)}));else if(o.name==="metadata.json")a.push(o.async("string").then(n=>{const g=JSON.parse(n);e.project=g}));else if(o.name==="settings.json")a.push(o.async("string").then(n=>{e.settings=JSON.parse(n)}));else{const n=o.name.split("/");if(n.length===2&&n[1]&&n[0]==="images"){const g=n[1].split(".");g.length===2&&a.push(o.async("base64").then(m=>{l.set(g[0],`data:image/jpeg;base64,${m}`)}))}}}),await Promise.all(a),e.project){if(e.project.id&&e.meta.length>0&&x.add(e.project.id),e.project.dependencies.forEach(i=>{x.has(i)||console.warn("Missing dependency")}),e.project.version>I)throw new Error("bad_version");e.project.encoderURL&&(console.log("Loading encoder",e.project.encoderURL),s.setEncoderModel(e.project.encoderURL).then(()=>{console.log("Encoder loaded")})),e.project.labelLocale&&D.addLabelLocales(e.project.labelLocale)}const u=Math.max(z(e.logs),e.graph?U(e.graph.edges):0),p=Date.now()-u;if(e.graph){const i=new Map;e.graph.nodes.forEach(o=>{var n;if(o.type==="topic"){const g=o.data.label;i.set(o.id,g),o.id=B(s.graph,g)}o.type==="user"&&Array.isArray((n=o.data)==null?void 0:n.featureWeights)&&(o.data.featureWeights={})}),s.graph.addNodes(e.graph.nodes.filter(o=>!!o.data))}return e.meta.forEach(i=>{var o;for(let n=0;n<i.labels.length;++n)K(i.labels[n].label)&&(i.labels[n].weight*=.1);s.addContent({normal:l.get(`${i.id}`)||`${k}/${i.id}.jpg`,lowRes:l.get(`${i.id}_low`)||((o=e.project)!=null&&o.hasLowResolution?`${k}/${i.id}_low.jpg`:void 0)},i)}),e.graph||e.users.forEach(i=>{try{i.name!=="NoName"&&s.graph.addNode("user",i.id,i)}catch{console.warn("User already exists")}}),G(e.logs,p),e.logs.forEach(i=>{t.appendActionLog(i.log,i.id)}),t.sortLogs(),e.settings}const Z="#e8f0fe",Q="#ffcbcb",X="rgb(2, 136, 209)",ee="_title_1qiel_3",se="_content_1qiel_8",te="_errorTitle_1qiel_18",oe="_errorContent_1qiel_23",j={bgSubdued1:Z,bgError:Q,borderBrightBlue:X,title:ee,content:se,errorTitle:te,errorContent:oe};function ne({error:s}){const{t}=T();return d.jsxs(O,{hideBackdrop:!0,open:s!=="none",children:[d.jsx(C,{className:j.errorTitle,children:t("loader.titles.error")}),d.jsx(J,{className:j.errorContent,children:d.jsx("div",{children:t(`loader.errors.${s}`)})})]})}function re({status:s,progress:t}){const{t:r}=T();return d.jsxs(O,{hideBackdrop:!0,open:s!=="none",children:[d.jsx(C,{className:j.title,children:r("loader.titles.contentLoad")}),d.jsxs(J,{className:j.content,children:[d.jsx("div",{children:r(`loader.messages.content_${s}`)}),d.jsx(q,{style:{width:"100%"},variant:t===void 0?"indeterminate":"determinate",value:t===void 0?void 0:Math.floor(t)})]})]})}function he({content:s,onLoaded:t,noSession:r,noConfig:c}){const l=y.useRef(new Set),[e,a]=y.useState("waiting"),[u,p]=y.useState(),i=P(),{content:o,actionLog:n}=M();return y.useEffect(()=>{if(s&&s.length>0){const g=s.filter(f=>typeof f=="string"?!l.current.has(f):!0);if(g.length===0)return;a("downloading");const m=[],v=new Array(g.length).fill(0);g.forEach((f,E)=>{typeof f=="string"&&l.current.add(f),m.push(V(f,h=>{v[E]=h,p(v.reduce((w,A)=>w+A,0)/g.length)}))}),Promise.all(m).then(f=>{a("loading"),p(void 0);const E=f.map(h=>Y(o,n,h));Promise.all(E).then(h=>{c||h.forEach(w=>{w&&i(w)}),a("done"),r||N(o.graph,n),t&&t()}).catch(h=>{console.error(h),a("failed-load")})}).catch(f=>{console.error(f),a("failed-download")})}else s?(a("done"),r||N(o.graph,n),t&&t()):a("waiting")},[s,t,i,o,n,r,c]),d.jsxs(d.Fragment,{children:[d.jsx(re,{status:e==="downloading"?"download":e==="loading"?"load":"none",progress:u}),d.jsx(ne,{error:e==="failed-download"?"download":e==="failed-load"?"load":"none"})]})}export{he as C,pe as c,V as g,Y as l};
