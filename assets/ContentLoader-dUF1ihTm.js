import{a0 as M,c as T,j as d,r as y,l as I}from"./index-ChHXuf40.js";import{J as P,d as x,V as $,a as D}from"./settings-DBbq7qFG.js";import{l as j}from"./lz-string-CzHELm9r.js";import{l as B}from"./localiser-C36yOspj.js";import{D as O,a as J}from"./DialogContent-_GwcI3J5.js";import{D as C}from"./DialogTitle-DRIas77U.js";import{L as q}from"./LinearProgress-li3lTmA_.js";function U(s){return s.reduce((t,a)=>Math.max(t,a.timestamp),0)}function z(s){return s.reduce((t,a)=>Math.max(t,a.log.reduce((c,l)=>Math.max(c,l.timestamp),0)),0)}function G(s,t){s.forEach(a=>{a.log.forEach(c=>{c.timestamp+=t})})}const S="genai_somekone_graph",b="genai_somekone_logs";let L=!1;const R={save:!0};function de(){R.save=!1}function N(s,t){const a=window.sessionStorage.getItem(S);window.sessionStorage.removeItem(S);const c=window.sessionStorage.getItem(b);if(window.sessionStorage.removeItem(b),a){const l=JSON.parse(j.decompress(a));s.addNodes(l)}c&&JSON.parse(j.decompress(c)).forEach(e=>{t.appendActionLog(e.log,e.id)}),L||(window.addEventListener("beforeunload",()=>{if(R.save)try{window.sessionStorage.setItem(S,j.compress(JSON.stringify(s.dumpNodes())));const e=s.getNodesByType("user").map(r=>({id:r,log:t.getActionLog(r)}));window.sessionStorage.setItem(b,j.compress(JSON.stringify(e)))}catch(l){console.log("Save error",l)}}),L=!0)}const H=["cute","scary","dark","funny","happy","sad","artistic","beautiful","angry","complex","simple","indoor","outdoor","day","night","active","calm","adventure","romantic","colourful","inspiring","söpö","pelottava","synkkä","hauska","onnellinen","surullinen","taiteellinen","kaunis","vihainen","romanttinen","rauhallinen","kiehtova","elävä","kotoisa","salaperäinen","sopusointuinen","ihastuttava","hurmaava","unenomainen"],F=new Set(H);function K(s){return F.has(s)}const k="https://store.gen-ai.fi/somekone/images";async function V(s,t){if(typeof s=="string"){t&&t(0);const a=await fetch(s);if(a.status!==200)throw console.error(a),new Error("zip_fetch_failed");const c=[];if(a.body){const l=a.body.getReader(),e=parseInt(a.headers.get("Content-Length")||"1");let r=0;for(;r<e;){const{done:m,value:g}=await l.read();if(m)break;c.push(g),r+=g.length,t&&t(Math.floor(r/e*100))}}return new Blob(c)}else return t&&t(100),new Blob([s])}function W(s){return s.forEach(t=>{t.log.forEach(a=>{switch(a.activity){case"love":case"wow":case"laugh":case"anger":case"sad":a.activity="like";break;case"share_friends":case"share_private":a.activity="share_public";break}})}),s}async function Y(s,t,a){const c=await P.loadAsync(a),l=new Map,e={meta:[],users:[],logs:[]},r=[];if(c.forEach((i,o)=>{if(o.name==="content.json")r.push(o.async("string").then(n=>{e.meta=JSON.parse(n)}));else if(o.name==="users.json")r.push(o.async("string").then(n=>{e.users=JSON.parse(n)}));else if(o.name==="logs.json")r.push(o.async("string").then(n=>{e.logs=W(JSON.parse(n))}));else if(o.name==="graph.json")r.push(o.async("string").then(n=>{e.graph=JSON.parse(n)}));else if(o.name==="metadata.json")r.push(o.async("string").then(n=>{const p=JSON.parse(n);e.project=p}));else if(o.name==="settings.json")r.push(o.async("string").then(n=>{e.settings=JSON.parse(n)}));else{const n=o.name.split("/");if(n.length===2&&n[1]&&n[0]==="images"){const p=n[1].split(".");p.length===2&&r.push(o.async("base64").then(u=>{l.set(p[0],`data:image/jpeg;base64,${u}`)}))}}}),await Promise.all(r),e.project){if(e.project.id&&e.meta.length>0&&x.add(e.project.id),e.project.dependencies.forEach(i=>{x.has(i)||console.warn("Missing dependency")}),e.project.version>$)throw new Error("bad_version");e.project.encoderURL&&(console.log("Loading encoder",e.project.encoderURL),s.setEncoderModel(e.project.encoderURL).then(()=>{console.log("Encoder loaded")})),e.project.labelLocale&&B.addLabelLocales(e.project.labelLocale)}const m=Math.max(z(e.logs),e.graph?U(e.graph.edges):0),g=Date.now()-m;if(e.graph){const i=new Map;e.graph.nodes.forEach(o=>{var n;if(o.type==="topic"){const p=o.data.label;i.set(o.id,p),o.id=M(s.graph,p)}o.type==="user"&&Array.isArray((n=o.data)==null?void 0:n.featureWeights)&&(o.data.featureWeights={})}),s.graph.addNodes(e.graph.nodes.filter(o=>!!o.data))}return e.meta.forEach(i=>{var o;for(let n=0;n<i.labels.length;++n)K(i.labels[n].label)&&(i.labels[n].weight*=.1);s.addContent({normal:l.get(`${i.id}`)||`${k}/${i.id}.jpg`,lowRes:l.get(`${i.id}_low`)||((o=e.project)!=null&&o.hasLowResolution?`${k}/${i.id}_low.jpg`:void 0)},i)}),e.graph||e.users.forEach(i=>{try{i.name!=="NoName"&&s.graph.addNode("user",i.id,i)}catch{console.warn("User already exists")}}),G(e.logs,g),e.logs.forEach(i=>{t.appendActionLog(i.log,i.id)}),t.sortLogs(),e.settings}const Z="_title_1qiel_3",Q="_content_1qiel_8",X="_errorTitle_1qiel_18",ee="_errorContent_1qiel_23",_={title:Z,content:Q,errorTitle:X,errorContent:ee};function se({error:s}){const{t}=T();return d.jsxs(O,{hideBackdrop:!0,open:s!=="none",children:[d.jsx(C,{className:_.errorTitle,children:t("loader.titles.error")}),d.jsx(J,{className:_.errorContent,children:d.jsx("div",{children:t(`loader.errors.${s}`)})})]})}function te({status:s,progress:t}){const{t:a}=T();return d.jsxs(O,{hideBackdrop:!0,open:s!=="none",children:[d.jsx(C,{className:_.title,children:a("loader.titles.contentLoad")}),d.jsxs(J,{className:_.content,children:[d.jsx("div",{children:a(`loader.messages.content_${s}`)}),d.jsx(q,{style:{width:"100%"},variant:t===void 0?"indeterminate":"determinate",value:t===void 0?void 0:Math.floor(t)})]})]})}function pe({content:s,onLoaded:t,noSession:a,noConfig:c}){const l=y.useRef(new Set),[e,r]=y.useState("waiting"),[m,g]=y.useState(),i=D(),{content:o,actionLog:n}=I();return y.useEffect(()=>{if(s&&s.length>0){const p=s.filter(f=>typeof f=="string"?!l.current.has(f):!0);if(p.length===0)return;r("downloading");const u=[],v=new Array(p.length).fill(0);p.forEach((f,E)=>{typeof f=="string"&&l.current.add(f),u.push(V(f,h=>{v[E]=h,g(v.reduce((w,A)=>w+A,0)/p.length)}))}),Promise.all(u).then(f=>{r("loading"),g(void 0);const E=f.map(h=>Y(o,n,h));Promise.all(E).then(h=>{c||h.forEach(w=>{w&&i(w)}),r("done"),a||N(o.graph,n),t&&t()}).catch(h=>{console.error(h),r("failed-load")})}).catch(f=>{console.error(f),r("failed-download")})}else s?(r("done"),a||N(o.graph,n),t&&t()):r("waiting")},[s,t,i,o,n,a,c]),d.jsxs(d.Fragment,{children:[d.jsx(te,{status:e==="downloading"?"download":e==="loading"?"load":"none",progress:m}),d.jsx(se,{error:e==="failed-download"?"download":e==="failed-load"?"load":"none"})]})}export{pe as C,de as c,V as g,Y as l};
