var T=Object.defineProperty;var k=(t,o,e)=>o in t?T(t,o,{enumerable:!0,configurable:!0,writable:!0,value:e}):t[o]=e;var b=(t,o,e)=>(k(t,typeof o!="symbol"?o+"":o,e),e);import{ab as D,j as g,ac as H,c as L,r as u,g as q,h as G,R as O,ad as F}from"./index-02b2945e.js";import{c as Y}from"./configState-6be3aa1d.js";import{i as U,C as W}from"./colours-9cdd3933.js";import{a as X}from"./events-63b5f19e.js";import{s as Z}from"./svgToPNG-975d57d1.js";import{F as J}from"./FileSaver.min-7671c644.js";import{P as K}from"./ProgressDialog-7226fde1.js";import{u as Q}from"./profiler-25e786d5.js";function V(t,o,e){return new Promise(n=>{let r=0;const i=new Array(t.length),a=()=>{let s=o;for(;s--&&r<t.length;){try{i[r]=e(t[r])}catch(h){console.error("Batch error",h)}r+=1}r<t.length?setTimeout(a,0):n(i)};setTimeout(a,0)})}const tt=10;function et(t,o){const e=t.getNodesByType("content"),n=o||Math.floor(Math.sqrt(e.length));return D(e,n*n,r=>r)}async function nt(t,o,e,n,r){if(n){const i=await V(o,100,s=>({candidateOrigin:"popular",contentId:s,timestamp:Date.now(),candidateProbability:t.getCandidateProbability(n,9*tt,r.recommendations,s)})),a=t.getScoringProbabilities(e,i,n,9,r.recommendations);return a.sort((s,h)=>(h.probability||0)-(s.probability||0)),a.map(s=>({id:s.contentId,weight:s.probability||0}))}return o.map(i=>({id:i,weight:0}))}const st="#008297",ot="_loading_1311g_3",rt="_container_1311g_15",it="_svg_1311g_22",at="_label_1311g_27",j={primary:st,loading:ot,container:rt,svg:it,label:at};function ct(t,o=1){const e=t.reduce((a,s)=>a+s.weight,0)/t.length,n=t.reduce((a,s)=>a+(s.weight-e)*(s.weight-e),0)/t.length,r=Math.sqrt(n);return t.map(a=>({id:a.id,weight:Math.min(1,a.weight/(e+o*r))}))}const ht=new W;function dt({label:t}){const o=ht.get(t);return g.jsx("div",{className:j.label,style:{background:o,color:U(o)?"black":"white"},children:t})}function ut(t,o,e){var a;const n=[],r=new Set,i=t.length;for(n.push({pt:o,d:0}),r.add((o[0]<<8)+o[1]);n.length>0;){const s=n.pop();if(!s)break;if(((a=t[s.pt[1]])==null?void 0:a[s.pt[0]])===null)return s.pt;[[s.pt[0]+1,s.pt[1]],[s.pt[0]-1,s.pt[1]],[s.pt[0],s.pt[1]+1],[s.pt[0],s.pt[1]-1]].forEach(c=>{if(c[0]<0||c[0]>=i||c[1]<0||c[1]>=i)return;const m=(c[0]<<8)+c[1];if(!r.has(m)){r.add(m);const w=c[0]-o[0],f=c[1]-o[1],S=w*w+f*f;S<e*e&&n.push({pt:c,d:S})}}),n.sort((c,m)=>m.d-c.d)}return[-1,-1]}function lt(t,o,e){const n=new Array(e);for(let r=0;r<e;++r){const i=new Array(e);i.fill(null),n[r]=i}return o.forEach(r=>{var h;const i=((h=t.getContentMetadata(r))==null?void 0:h.point)||[Math.random(),Math.random()],a=[Math.floor(i[0]*e),Math.floor(i[1]*e)],s=ut(n,a,100);s[0]>=0&&(n[s[1]][s[0]]=r)}),n}class gt extends H{constructor(e,n){super();b(this,"contentSvc");b(this,"data",new Map);b(this,"count",0);b(this,"resetCount");b(this,"dataSetSize");b(this,"dim");b(this,"grid",[]);this.contentSvc=e,this.dataSetSize=n.dataSetSize,this.dim=n.dim??Math.floor(Math.sqrt(e.getAllContent().length)),this.resetCount=n.refreshCount??10}addData(e,n){this.data.set(e,n),this.data.size>=this.dataSetSize&&(this.count--,this.count<=0&&this.generateGrid())}generateGrid(){this.count=this.resetCount*this.dataSetSize;const e=this.mergeAndSort();this.grid=lt(this.contentSvc,e.map(n=>n.id),this.dim),this.emit("grid",this.grid)}mergeAndSort(){const e=new Map;this.data.forEach(r=>{r.forEach(i=>{const a=e.get(i.id)||i;e.set(i.id,i.weight>a.weight?i:a)})});const n=Array.from(e.values());return n.sort((r,i)=>i.weight-r.weight),n}}const y=40,I=.1;function ft({data:t,dimensions:o,busy:e,label:n,invert:r,mapService:i,deviationFactor:a=1}){const{t:s}=L(),[h,E]=u.useState(),c=u.useRef(null),[m,w]=u.useState(!1),f=q(),[S,A]=u.useState(!1),[p,z]=u.useState(),N=u.useId(),$=t.length===0||!h||e,P=o||Math.floor(Math.sqrt(f.getAllContent().length));u.useEffect(()=>{z(i||new gt(f,{dataSetSize:1,dim:P}))},[i,f,P]),u.useEffect(()=>{if(p){const l=d=>{E(d)};return p.grid&&p.grid.length>0&&E(p.grid),p.on("grid",l),()=>{p.off("grid",l)}}},[p]);const v=200/P,x=u.useMemo(()=>t?ct(t,a):void 0,[t,a]),B=u.useMemo(()=>{const l=new Map;return x==null||x.forEach(d=>{l.set(d.id,d.weight)}),l},[x]);return u.useEffect(()=>{p&&x&&x.length>0&&p.addData(N,x)},[x,N,p]),u.useEffect(()=>{}),u.useEffect(()=>{m||c.current&&c.current.setAttribute("viewBox","0 0 200 200")},[m]),X(()=>{c.current&&(A(!0),Z(c.current,8,0).then(l=>{J.saveAs(l,n?`heatmap_${n}.png`:"heatmap.png"),A(!1)}))},[n],"save_heat"),g.jsxs("div",{className:j.container,children:[g.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:j.svg,width:"100%",height:"100%",viewBox:"0 0 200 200",ref:c,"data-testid":"heatmap-svg",onContextMenu:l=>l.preventDefault(),onPointerDown:l=>{if(w(!0),c.current){const d=c.current.getBoundingClientRect(),M=(l.clientX-d.left)/d.width*200,_=(l.clientY-d.top)/d.height*200,C=M-y/2,R=_-y/2;c.current.setAttribute("viewBox",`${C} ${R} ${y} ${y}`)}},onPointerUp:()=>w(!1),onPointerLeave:()=>w(!1),onPointerMove:l=>{if(c.current&&m){const d=c.current.getBoundingClientRect(),M=(l.clientX-d.left)/d.width*200,_=(l.clientY-d.top)/d.height*200,C=M-y/2,R=_-y/2;c.current.setAttribute("viewBox",`${C} ${R} ${y} ${y}`)}},children:g.jsx("g",{children:h==null?void 0:h.map((l,d)=>g.jsx("g",{children:l.map((M,_)=>{const C=M?(B.get(M)||0)*(1-I)+I:0;return M?g.jsxs(u.Fragment,{children:[g.jsx("image",{"data-testid":"heatmap-image",href:f.getContentData(M,!0),width:v,height:v,x:_*v,y:d*v}),g.jsx("rect",{x:_*v,y:d*v,width:v,height:v,opacity:r?C:1-C,fill:"white",stroke:"white",strokeWidth:.5})]},_):null})},d))})}),n&&g.jsx(dt,{label:n}),$&&g.jsx("div",{className:j.loading,"data-testid":"loading-heatmap",children:g.jsx(G,{size:"large"})}),g.jsx(K,{title:s("common.titles.saving",{ns:"common"}),open:S})]})}function _t({user:t,dimensions:o,showName:e,invert:n,deviationFactor:r,imageSet:i,mapService:a}){const s=O(Y(t)),h=u.useRef(),[E,c]=u.useState(),[m,w]=u.useState(!1),f=Q(t),S=F();return i&&(h.current=i),u.useEffect(()=>{(!h.current||h.current.length===0)&&(w(!0),h.current=et(S.graph,o)),nt(S,h.current,t,f,s).then(A=>{c(A),w(!1)})},[o,t,s,f,S]),g.jsx(ft,{data:E||[],busy:m,dimensions:o,label:e?f.name:void 0,invert:n,deviationFactor:r,mapService:a})}export{ft as H,gt as M,_t as R,et as h};
