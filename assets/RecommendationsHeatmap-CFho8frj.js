var T=Object.defineProperty;var k=(t,o,n)=>o in t?T(t,o,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[o]=n;var b=(t,o,n)=>k(t,typeof o!="symbol"?o+"":o,n);import{aa as D,j as g,ab as G,c as H,r as u,g as L,p as q,R as O,ac as F}from"./index-ChHXuf40.js";import{c as Y}from"./configState-BS87aI9Z.js";import{C as U,i as W}from"./colours-yJq7kSUE.js";import{a as X}from"./events-DLU3_18Y.js";import{s as Z}from"./svgToPNG-Ltd00H6X.js";import{F as J}from"./FileSaver.min-D29rPHm2.js";import{P as K}from"./ProgressDialog-CeFbeIBT.js";import{u as Q}from"./profiler-BgoGrxGa.js";function V(t,o,n){return new Promise(e=>{let r=0;const i=new Array(t.length),a=()=>{let s=o;for(;s--&&r<t.length;){try{i[r]=n(t[r])}catch(h){console.error("Batch error",h)}r+=1}r<t.length?setTimeout(a,0):e(i)};setTimeout(a,0)})}const tt=10;function et(t,o){const n=t.getNodesByType("content"),e=o||Math.floor(Math.sqrt(n.length));return D(n,e*e,r=>r)}async function nt(t,o,n,e,r){if(e){const i=await V(o,100,s=>({candidateOrigin:"popular",contentId:s,timestamp:Date.now(),candidateProbability:t.getCandidateProbability(e,9*tt,r.recommendations,s)})),a=t.getScoringProbabilities(n,i,e,9,r.recommendations);return a.sort((s,h)=>(h.probability||0)-(s.probability||0)),a.map(s=>({id:s.contentId,weight:s.probability||0}))}return o.map(i=>({id:i,weight:0}))}const st="_loading_1311g_3",ot="_container_1311g_15",rt="_svg_1311g_22",it="_label_1311g_27",j={loading:st,container:ot,svg:rt,label:it};function at(t,o=1){const n=t.reduce((a,s)=>a+s.weight,0)/t.length,e=t.reduce((a,s)=>a+(s.weight-n)*(s.weight-n),0)/t.length,r=Math.sqrt(e);return t.map(a=>({id:a.id,weight:Math.min(1,a.weight/(n+o*r))}))}const ct=new U;function ht({label:t}){const o=ct.get(t);return g.jsx("div",{className:j.label,style:{background:o,color:W(o)?"black":"white"},children:t})}function dt(t,o,n){var a;const e=[],r=new Set,i=t.length;for(e.push({pt:o,d:0}),r.add((o[0]<<8)+o[1]);e.length>0;){const s=e.pop();if(!s)break;if(((a=t[s.pt[1]])==null?void 0:a[s.pt[0]])===null)return s.pt;[[s.pt[0]+1,s.pt[1]],[s.pt[0]-1,s.pt[1]],[s.pt[0],s.pt[1]+1],[s.pt[0],s.pt[1]-1]].forEach(c=>{if(c[0]<0||c[0]>=i||c[1]<0||c[1]>=i)return;const m=(c[0]<<8)+c[1];if(!r.has(m)){r.add(m);const w=c[0]-o[0],f=c[1]-o[1],S=w*w+f*f;S<n*n&&e.push({pt:c,d:S})}}),e.sort((c,m)=>m.d-c.d)}return[-1,-1]}function ut(t,o,n){const e=new Array(n);for(let r=0;r<n;++r){const i=new Array(n);i.fill(null),e[r]=i}return o.forEach(r=>{var h;const i=((h=t.getContentMetadata(r))==null?void 0:h.point)||[Math.random(),Math.random()],a=[Math.floor(i[0]*n),Math.floor(i[1]*n)],s=dt(e,a,100);s[0]>=0&&(e[s[1]][s[0]]=r)}),e}class lt extends G{constructor(n,e){super();b(this,"contentSvc");b(this,"data",new Map);b(this,"count",0);b(this,"resetCount");b(this,"dataSetSize");b(this,"dim");b(this,"grid",[]);this.contentSvc=n,this.dataSetSize=e.dataSetSize,this.dim=e.dim??Math.floor(Math.sqrt(n.getAllContent().length)),this.resetCount=e.refreshCount??10}addData(n,e){this.data.set(n,e),this.data.size>=this.dataSetSize&&(this.count--,this.count<=0&&this.generateGrid())}refresh(){this.generateGrid()}generateGrid(){this.count=this.resetCount*this.dataSetSize;const n=this.mergeAndSort();this.grid=ut(this.contentSvc,n.map(e=>e.id),this.dim),this.emit("grid",this.grid)}mergeAndSort(){const n=new Map;this.data.forEach(r=>{r.forEach(i=>{const a=n.get(i.id)||i;n.set(i.id,i.weight>a.weight?i:a)})});const e=Array.from(n.values());return e.sort((r,i)=>i.weight-r.weight),e}}const y=40,I=.1;function gt({data:t,dimensions:o,busy:n,label:e,invert:r,mapService:i,deviationFactor:a=1}){const{t:s}=H(),[h,E]=u.useState(),c=u.useRef(null),[m,w]=u.useState(!1),f=L(),[S,A]=u.useState(!1),[p,z]=u.useState(),N=u.useId(),$=t.length===0||!h||n,P=o||Math.floor(Math.sqrt(f.getAllContent().length));u.useEffect(()=>{z(i||new lt(f,{dataSetSize:1,dim:P}))},[i,f,P]),u.useEffect(()=>{if(p){const l=d=>{E(d)};return p.grid&&p.grid.length>0&&E(p.grid),p.on("grid",l),()=>{p.off("grid",l)}}},[p]);const v=200/P,x=u.useMemo(()=>t?at(t,a):void 0,[t,a]),B=u.useMemo(()=>{const l=new Map;return x==null||x.forEach(d=>{l.set(d.id,d.weight)}),l},[x]);return u.useEffect(()=>{p&&x&&x.length>0&&p.addData(N,x)},[x,N,p]),u.useEffect(()=>{}),u.useEffect(()=>{m||c.current&&c.current.setAttribute("viewBox","0 0 200 200")},[m]),X(()=>{c.current&&(A(!0),Z(c.current,8,0).then(l=>{J.saveAs(l,e?`heatmap_${e}.png`:"heatmap.png"),A(!1)}))},[e],"save_heat"),g.jsxs("div",{className:j.container,children:[g.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:j.svg,width:"100%",height:"100%",viewBox:"0 0 200 200",ref:c,"data-testid":"heatmap-svg",onContextMenu:l=>l.preventDefault(),onPointerDown:l=>{if(w(!0),c.current){const d=c.current.getBoundingClientRect(),M=(l.clientX-d.left)/d.width*200,_=(l.clientY-d.top)/d.height*200,C=M-y/2,R=_-y/2;c.current.setAttribute("viewBox",`${C} ${R} ${y} ${y}`)}},onPointerUp:()=>w(!1),onPointerLeave:()=>w(!1),onPointerMove:l=>{if(c.current&&m){const d=c.current.getBoundingClientRect(),M=(l.clientX-d.left)/d.width*200,_=(l.clientY-d.top)/d.height*200,C=M-y/2,R=_-y/2;c.current.setAttribute("viewBox",`${C} ${R} ${y} ${y}`)}},children:g.jsx("g",{children:h==null?void 0:h.map((l,d)=>g.jsx("g",{children:l.map((M,_)=>{const C=M?(B.get(M)||0)*(1-I)+I:0;return M?g.jsxs(u.Fragment,{children:[g.jsx("image",{"data-testid":"heatmap-image",href:f.getContentData(M,!0),width:v,height:v,x:_*v,y:d*v}),g.jsx("rect",{x:_*v,y:d*v,width:v,height:v,opacity:r?C:1-C,fill:"white",stroke:"white",strokeWidth:.5})]},_):null})},d))})}),e&&g.jsx(ht,{label:e}),$&&g.jsx("div",{className:j.loading,"data-testid":"loading-heatmap",children:g.jsx(q,{size:"large"})}),g.jsx(K,{title:s("common.titles.saving",{ns:"common"}),open:S})]})}function yt({user:t,dimensions:o,showName:n,invert:e,deviationFactor:r,imageSet:i,mapService:a}){const s=O(Y(t)),h=u.useRef(),[E,c]=u.useState(),[m,w]=u.useState(!1),f=Q(t),S=F();return i&&(h.current=i),u.useEffect(()=>{(!h.current||h.current.length===0)&&(w(!0),h.current=et(S.graph,o)),nt(S,h.current,t,f,s).then(A=>{c(A),w(!1)})},[o,t,s,f,S]),g.jsx(gt,{data:E||[],busy:m,dimensions:o,label:n?f.name:void 0,invert:e,deviationFactor:r,mapService:a})}export{gt as H,lt as M,yt as R,et as h};
