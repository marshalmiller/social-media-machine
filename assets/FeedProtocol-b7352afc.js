import{r as s,b as S,a as V,R as F,m as H,j as U}from"./index-02b2945e.js";import{I as M}from"./peer-d87849a6.js";import{b as O,i as $,c as K}from"./sessionState-6915fb12.js";import{a as Y}from"./configState-6be3aa1d.js";import{L as q}from"./logger-fbaa4ff5.js";import{l as z}from"./lz-string-35001fa0.js";import{b as G,C as J,d as Q}from"./ConnectionStatus-d4cfcdbc.js";const W=15*60*1e3,X="genai_somekone_username",x=s.createContext({});function ie(){return s.useContext(x)}function ce({content:P,server:g,mycode:T,setContent:p,children:A}){const C=s.useRef(Date.now()),E=s.useRef(-1),R=S(O),[_,b]=V(Y),h=S($),m=F(K),v=s.useRef(!1),[I,w]=s.useState(!1),{content:o,profiler:t,actionLog:a,recommender:k}=H(),j=s.useCallback((e,i)=>{var f;if(e.event==="eter:config"&&e.configuration)b(r=>({...r,...e.configuration})),e.content&&p&&p(e.content);else if(e.event==="eter:users")R(e.users);else if(e.event==="eter:profile_data"){if(v.current){console.info("Skipping profile update");return}t.reverseProfile(e.id,e.profile)}else if(e.event==="eter:action_log"){if(v.current)return;v.current=!0,a.appendActionLog(e.log,e.id)}else if(e.event==="eter:comment")o.addComment(e.contentId,e.id,e.comment,e.timestamp);else if(e.event==="eter:join"){const r=t.getUserProfile(),c=a.getActionLogSince(Date.now()-W,t.getCurrentUser()).filter(d=>d.timestamp<=C.current),u=k.getRecommendations(t.getCurrentUser(),5,_.recommendations);i.send({event:"eter:config",configuration:_,content:P}),i.send({event:"eter:reguser",username:m||"NoName",id:t.getCurrentUser()}),i.send({event:"eter:action_log",id:t.getCurrentUser(),log:c}),i.send({event:"eter:profile_data",profile:r,id:t.getCurrentUser()}),i.send({event:"eter:recommendations",recommendations:u,id:t.getCurrentUser()}),i.send({event:"eter:connect",code:`sm-${g}`})}else if(e.event==="eter:inject")e.to===t.getCurrentUser()&&h(r=>[{...e,timestamp:Date.now()},...r.slice(0,5)]);else if(e.event==="eter:newpost")e.data?G(e.data).then(r=>{o.hasContent(`content:${e.meta.id}`)?o.addContentData(r,e.meta):o.addContent(r,e.meta)}):o.addContentMeta(e.meta);else if(e.event==="eter:snapshot"&&e.snapshot){const r=e.compressed?JSON.parse(z.decompressFromUTF16(e.snapshot)):e.snapshot;t.graph.addNodes(r.nodes),t.graph.addEdges(r.edges.map(c=>({...c,timestamp:Date.now(),metadata:{}}))),(f=r.logs)==null||f.forEach(c=>{c.user!==t.getCurrentUser()&&a.addLogEntry(c.entry,c.user)})}else e.event==="eter:stats"&&(o.updateContentStats(e.content),t.setBestEngagement(e.bestEngagement))},[_,m,P,g,b,R,p,o,t,a,k,h]),{ready:l,send:n,peer:D}=M({host:{}.VITE_APP_PEER_SERVER,secure:{}.VITE_APP_PEER_SECURE==="1",key:{}.VITE_APP_PEER_KEY||"peerjs",port:{}.VITE_APP_PEER_PORT?parseInt({}.VITE_APP_PEER_PORT):443,code:g&&`sm-${T}`,server:`sm-${g}`,onData:j});s.useEffect(()=>{m&&n&&l&&(window.sessionStorage.setItem(X,m),t.setUserName(t.getCurrentUser(),m),n({event:"eter:reguser",username:m,id:t.getCurrentUser()}),n({event:"eter:snapshot",id:t.getCurrentUser()}))},[m,n,l,t]);const y=s.useCallback(()=>{},[]),L=s.useCallback(e=>{n&&n({event:"eter:profile_data",profile:e,id:t.getCurrentUser()})},[n,t]),N=s.useCallback(e=>{n&&(n({event:"eter:recommendations",recommendations:e,id:t.getCurrentUser()}),n({event:"eter:snapshot",id:t.getCurrentUser()}))},[n,t]);return s.useEffect(()=>{w(!0)},[l]),s.useEffect(()=>{const e=r=>{const c=t.getCurrentUser(),u=o.getContentMetadata(r),d=o.getContentData(r);n&&u&&d&&u.authorId===c&&Q(d).then(B=>{n({event:"eter:newpost",meta:u,data:B})})},i=r=>{n&&o.hasContent(r)&&n({event:"eter:request_content",id:r})},f=()=>{n&&n&&E.current===-1&&(E.current=window.setTimeout(()=>{E.current=-1;const r=a.getActionLogSince(C.current,t.getCurrentUser());C.current=Date.now(),n({event:"eter:action_log",id:t.getCurrentUser(),log:r})},500))};return o.broker.on("posted",e),o.broker.on("contentmissing",i),a.broker.on("logdata-engagement",f),a.broker.on("logdata-comment",f),()=>{o.broker.off("posted",e),o.broker.off("contentmissing",i),o.broker.off("logdata-engagement",f),o.broker.off("logdata-comment",f)}},[o,n,t,a]),U.jsxs(x.Provider,{value:{doRecommend:N,doLog:y,doProfile:L},children:[I&&U.jsx(q,{sender:n,children:A}),U.jsx(J,{peer:D,ready:l,position:"center",visibility:0})]})}export{ce as F,ie as u};
