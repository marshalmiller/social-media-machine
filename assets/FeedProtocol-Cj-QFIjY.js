import{r as s,b as S,a as F,R as H,l as M,j as h}from"./index-ChHXuf40.js";import{I as $}from"./peer-CwAa3h8x.js";import{b as O,i as q,c as z}from"./sessionState-BwviDT66.js";import{a as G}from"./configState-BS87aI9Z.js";import{L as J}from"./logger-D3dC2Cq8.js";import{l as K}from"./lz-string-CzHELm9r.js";import{b as Y,C as Q,d as V}from"./ConnectionStatus-rnumxp5B.js";const W=15*60*1e3,X="genai_somekone_username",w=s.createContext({});function ie(){return s.useContext(w)}function ce({content:_,server:g,mycode:j,setContent:p,children:D}){const C=s.useRef(Date.now()),v=s.useRef(-1),k=S(O),[U,E]=F(G),x=S(q),f=H(z),b=s.useRef(!1),[y,L]=s.useState(!1),{content:o,profiler:t,actionLog:a,recommender:R}=M(),P=s.useCallback((e,i)=>{var m;if(e.event==="eter:config"&&e.configuration)E(r=>({...r,...e.configuration})),e.content&&p&&p(e.content);else if(e.event==="eter:users")k(e.users);else if(e.event==="eter:profile_data"){if(b.current){console.info("Skipping profile update");return}t.reverseProfile(e.id,e.profile)}else if(e.event==="eter:action_log"){if(b.current)return;b.current=!0,a.appendActionLog(e.log,e.id)}else if(e.event==="eter:comment")o.addComment(e.contentId,e.id,e.comment,e.timestamp);else if(e.event==="eter:join"){const r=t.getUserProfile(),c=a.getActionLogSince(Date.now()-W,t.getCurrentUser()).filter(d=>d.timestamp<=C.current),u=R.getRecommendations(t.getCurrentUser(),5,U.recommendations);i.send({event:"eter:config",configuration:U,content:_}),i.send({event:"eter:reguser",username:f||"NoName",id:t.getCurrentUser()}),i.send({event:"eter:action_log",id:t.getCurrentUser(),log:c}),i.send({event:"eter:profile_data",profile:r,id:t.getCurrentUser()}),i.send({event:"eter:recommendations",recommendations:u,id:t.getCurrentUser()}),i.send({event:"eter:connect",code:`sm-${g}`})}else if(e.event==="eter:inject")e.to===t.getCurrentUser()&&x(r=>[{...e,timestamp:Date.now()},...r.slice(0,5)]);else if(e.event==="eter:newpost")e.data?Y(e.data).then(r=>{o.hasContent(`content:${e.meta.id}`)?o.addContentData(r,e.meta):o.addContent(r,e.meta)}):o.addContentMeta(e.meta);else if(e.event==="eter:snapshot"&&e.snapshot){const r=e.compressed?JSON.parse(K.decompressFromUTF16(e.snapshot)):e.snapshot;t.graph.addNodes(r.nodes),t.graph.addEdges(r.edges.map(c=>({...c,timestamp:Date.now(),metadata:{}}))),(m=r.logs)==null||m.forEach(c=>{c.user!==t.getCurrentUser()&&a.addLogEntry(c.entry,c.user)})}else e.event==="eter:stats"&&(o.updateContentStats(e.content),t.setBestEngagement(e.bestEngagement))},[U,f,_,g,E,k,p,o,t,a,R,x]),{ready:l,send:n,peer:A}=$({host:void 0,secure:!1,key:"peerjs",port:443,code:g&&`sm-${j}`,server:`sm-${g}`,onData:P});s.useEffect(()=>{f&&n&&l&&(window.sessionStorage.setItem(X,f),t.setUserName(t.getCurrentUser(),f),n({event:"eter:reguser",username:f,id:t.getCurrentUser()}),n({event:"eter:snapshot",id:t.getCurrentUser()}))},[f,n,l,t]);const N=s.useCallback(()=>{},[]),T=s.useCallback(e=>{n&&n({event:"eter:profile_data",profile:e,id:t.getCurrentUser()})},[n,t]),B=s.useCallback(e=>{n&&(n({event:"eter:recommendations",recommendations:e,id:t.getCurrentUser()}),n({event:"eter:snapshot",id:t.getCurrentUser()}))},[n,t]);return s.useEffect(()=>{L(!0)},[l]),s.useEffect(()=>{const e=r=>{const c=t.getCurrentUser(),u=o.getContentMetadata(r),d=o.getContentData(r);n&&u&&d&&u.authorId===c&&V(d).then(I=>{n({event:"eter:newpost",meta:u,data:I})})},i=r=>{n&&o.hasContent(r)&&n({event:"eter:request_content",id:r})},m=()=>{n&&n&&v.current===-1&&(v.current=window.setTimeout(()=>{v.current=-1;const r=a.getActionLogSince(C.current,t.getCurrentUser());C.current=Date.now(),n({event:"eter:action_log",id:t.getCurrentUser(),log:r})},500))};return o.broker.on("posted",e),o.broker.on("contentmissing",i),a.broker.on("logdata-engagement",m),a.broker.on("logdata-comment",m),()=>{o.broker.off("posted",e),o.broker.off("contentmissing",i),o.broker.off("logdata-engagement",m),o.broker.off("logdata-comment",m)}},[o,n,t,a]),h.jsxs(w.Provider,{value:{doRecommend:B,doLog:N,doProfile:T},children:[y&&h.jsx(J,{sender:n,children:D}),h.jsx(Q,{peer:A,ready:l,position:"center",visibility:0})]})}export{ce as F,ie as u};
